#巡天观测脚本生成系统操作说明

*Version 1.0* **郑捷 2016-07**

## 运行环境

操作系统：建议Linux，或者MacOS。Windows下需适当修改程序。

语言环境：python 2.7/3.5，系统自带环境即可。也可以使用anaconda等。

语言包：astropy, numpy, matplotlib。

## 文件目录

*以下说明中目录符号`.`，表示本系统根目录，不是绝对路径。*

`jjjj`：*表示JD的最后4位，根据观测站所在时区的当天18:00时的JD表示。*

`yyyy.mm.dd`：*用2位年、2位月、2位日表示的日期，注意，年、月必须是正常的数值，而日可以是1-31之外的数字，例如-2，表示上个月的倒数第三天，而32，表示下个月的第1或者第2天，在特殊情况下可以适当扩展。*

`yyyymm`：*表示观测月名称（run)，通常采用年月表示，但是对于一个月内有两个run的情况，可能需要在后面加上AB等加以区分。另外，当某个观测安排从上个自然月月底延续到下个自然月月初时，下个月月初的观测计入前一个月，而非下一个月。*

大小写：*除涉及到4位JD前面加的大写*`J`*之外，其余目录、文件名等，一律用小写字母和数字，中间分隔符号一律用`.`。*

+ `./` 程序所在主目录；
+ `./manual/` 本手册所在目录；
+ `./xao/` 南山一米望远镜数据目录，内有3个子目录；
+ `./xao/conf/` 配置文件目录，内有若干配置文件；
    - `basic.txt` 望远镜基本信息，每行一个数据，依次为：经度，纬度，海拔，时区，间隔时间，视场，脚本模板。_其中，间隔时间是读出时间、望远镜指向时间、其他可能的小间断时间等的均摊时间，不包括可能出现的大中断，比如设备故障、临时插入其他观测等。_
    - `field.txt` 视场编号，目前已经编制好，不需要改动。各列分别为：视场编号、赤经、赤纬、银经、银纬、区块编号。
    - `expplan.txt` 观测计划。每行代表一个观测计划，各列分别为：编号、名称、滤光片、曝光时间、重复次数、每次完成因子、是否激活、偏移量。
    - `expmode.txt` 曝光模式。每行代表一种曝光模式，用于表示某种具体曝光属于那个观测计划。
+ `./xao/obsed/` 观测历史目录，内根据观测月分子目录；
+ `./xao/obsed/yyyymm/` 某个RUN的观测历史目录；
    - `files.Jjjjj.lst` 某天的观测文件列表
    - `check.Jjjjj.lst` 某天观测文件头信息
    - `obsed.Jjjjj.lst` 某天观测历史情况汇总
+ `./xao/schedule/` 观测脚本目录，内根据观测月分子目录；
+ `./xao/schedule/yyyymm/` 某个RUN的观测脚本目录，内根据观测日期分子目录；
+ `./xao/schedule/yyyymm/Jjjjj/` 具体某天的观测脚本目录；
    - `report.jjjj.yyyy.mm.dd.txt` 脚本生成报告，和生成脚本时屏幕报告相同。
    - `sumblock.jjjj.yyyy.mm.dd.txt` 脚本生成汇总，列举了每个区块的情况，主要用于机读分析。
    - `sumfield.jjjj.yyyy.mm.dd.txt`脚本生成汇总，列举了每个视场的情况，主要用于机读分析。
    - `plan.jjjj.yyyy.mm.dd.txt` 当晚脚本合并版本。是下面scr.....txt的合并版。
    - `plan.jjjj.yyyy.mm.dd.eps` 当晚观测天区图示，eps格式。
    - `plan.jjjj.yyyy.mm.dd.png` 当晚观测天区图示，png格式。
    - `chk.jjjj.nn.bbbbbbb.txt` 检查文件，第nn个区块，区块名称bbbbbbb，该文件用于说明为什么从候选区块中选中这一块。本文件主要用于检查选取机制是否合理。
    - `see.jjjj.nn.bbbbbbb.png` 选中的天区以及候选天区图示。chk和see文件只有选择了check参数才会输出。
    - `scr.jjjj.nn.bbbbbbb.txt` 生成的区块脚本。


## 观测前操作说明

### ① 生成当天脚本

#### 命令
shell命令1：`./takeoff.py xao 2016 8 6 [201608] [over] [simu] [check]`。

shell命令2：`python takeoff.py ......` 参数部分同上，略。

shell命令参数之间用空格分隔。

python命令：先进入python，然后执行：

```
import takeoff
takeoff.takeoff('bok', 2016, 8, 6, run='201608',
    obs_begin=22.5, obs_end=5.75,
    overwrite=True|False, simulate=True|False, check=True|False)
```

python命令参数之间用逗号分隔，run、overwrite、simulate、check可以省略，但是不能缩写，字符串参数必须加引号（单双引号均可），数字前不要加0。

#### 参数说明
+ `xao` 望远镜代号，对于南山一米，使用本代号。
+ `2016 8 6` 观测日期，当地时间年、月、日。
+ `201608` 可选参数，run名称，默认为年+月。
+ `over` 可选参数，直接写该字符串。如果之前已经生成过脚本，要重新生成，必须加该参数，否则会提示脚本已存在，禁止覆盖。
+ `simu` 可选参数，如果指定了该参数，那么会将当晚的脚本模拟生成已观测记录。该功能主要用于连续生成多个晚上的脚本时，需要先将之前的计划标注为已完成。
+ `check` 可选参数，用于生成每个区块的选择检查文件，供检查区块选择是否合理。
+ `obs_begin` 仅适用于进入python然后调用的方式，可选参数，指定开始观测时间，以所在时区小时数表示，例如22:30，写22.5。一般来说，程序会自动计算日出日落时间以及开始、结束观测时间，不需要额外指定。对南山一米，请使用**_北京时间_**。
+ `obs_end` 观测结束时间，要求与开始时间相同。可以输入5.75，也可以输入29.75，程序会自动处理。

#### 示例
##### 生成单个晚上脚本

`$ ./takeoff.py xao 2016 8 1 201608`

##### 连续生成多个晚上脚本
```
$ python
>>> import takeoff
>>> for d in range(1, 12) :
>>>     takeoff.takeoff('xao', 2016, 8, d, simulate=True)
>>>
```

如果需要连续生成多个晚上的脚本，可以用单晚方式逐个进行，也可以进入python后循环。*但是务必记住加上simu参数，否则将不断覆盖同一片天区。*

### ② 检查脚本

生成后，在`xao/schedule/201608/J7606/`下（J7606就是8月6日），检查当天晚上的观测脚本情况。

1. 看图检查观测天区分布是否合理。
2. 在summary或者report文件中查看每个天区的预计airmass是否正常，在report中查看airmass均值、最大、最小值是否正常。
3. 检查汇总得到的plan....txt文件，注意其中有空行，空行表示相邻两个field距离太远，可能会有较长的指向时间（对于BOK望远镜，这意味着需要去手动slew），或者需要进行焦距检查等等。在正式导入观测系统之前，需要手工删除空行，或者将其拆分为多个文件。
4. 检查report文件，看是否有SKIP提示。尤其到观测后期，如果在某个时间程序没能找到合适的观测目标，会自动跳过一段时间，要注意合理安排。
5. 如果观测未能按照计划进行，例如受天气影响，中间插入了其他观测，或者其他影响巡天观测的情况，那么在开始时，应检查report或者summary文件，根据其中标注的观测时间，选择合适的开始点进行观测，而不是直接从头开始或者从中断点开始。

## 观测后操作说明

### ③ 生成当天文件列表

用ls命令生成当天晚上的观测fits文件列表，保存为`xao/obsed/201608/files.J7606.lst`，注意其中的文件名最好为绝对路径，避免出现文件找不到的情况。

生成列表后，根据当天的观测日志，以及检查观测数据情况，将质量差以及出错的的文件名删除掉。即：列表中只包括“好”文件。

### ④ 检查当天文件信息

执行check程序：
`./check.py xao 2016 8 6`
参数含义同上。

本程序根据步骤③中生成的`files.Jxxxx.lst`文件，从观测fits文件中提取头信息，生成`check.Jxxxx.lst`文件。

③、④两步操作，必须在保存有观测文件的计算机上执行，随后将`check.Jxxxx.lst`文件复制出来。其余操作（包括生成脚本）可以在其他任何一台计算机上执行。

在其他计算机上执行步骤④所需要的环境

+ python语言环境，以及语言包：`astropy`, `numpy`
+ 本系统部分文件：`check.py`, `util.py`, `schdutil.py`, `headerinfo.py`, `xao/conf/basic.txt`
+ 需要手工建立的目录：`xao/obsed/yyyymm`，yyyymm根据需要设定


### ⑤ 汇总当天文件信息

执行collect程序：`./collect.py xao 2016 8 6` 参数含义同上。

本程序根据步骤④生成的`check.Jxxxx.lst`文件，结合配置文件，生成·`obsed.Jxxxx.lst`文件。

注意：如果`conf/expplan.txt`或`conf/expmode.txt`文件发生变化，那么必须对所有已经观测过的晚上的`check`文件，全部重新执行collect程序，否则后续生成脚本会出错。

### ⑥ 生成当天观测进度报告

执行footprint程序：`./footprint.py xao [Eequfile] [Ggalfile] [Rrun] [Dday] [B]`

##### 参数
+ `Eequfile` 生成的已观测天区图，赤道坐标系，其中首字母E不是文件名的一部分，只是表示这后面是赤道坐标系文件名。如果缺省参数，则会根据当前时间，在`xao/obsed/footprint`目录中生成。
+ `Ggalfile` 同上，指定银道坐标系下的图文件。
+ `Rrun` 表示图中对指定的run所观测的天区，会特别标注。
+ `Djjjj` jjjj表示指定日期，和run一起，表示特别标注这一天，而非整个run。在没有给出run参数时，单独指定本参数无意义。_**注意：这里用的是JD**_！
+ `B` 表示只绘制指定run或者日期之前的部分，并且特别标注指定run或日期。

用`R`、`D`、`B`等参数配合，可以逐个生成从开始观测到指定日期的进展情况，连续生成的多个图片，可以用ffmpeg等工具，生成动画，展示观测进展。

本工具仅绘制观测覆盖情况，文件质量、观测深度等，在图中不展示。观测天区数等，见图例标注。

## 具体文件解释

### expplan.txt

该文件中每行为一个观测计划，即滤光片+曝光时间，如果一个滤光片有多个不同曝光时间，如长短曝光，视为多个计划。

原始提供的xao配置文件中，包括了$b$、$y$、$Hw$、$Hn$等4个滤光片共8个计划，但是都已经注释掉，仅作为参考。

请根据需要，调整SDSS $g'$、$r'$、$i'$的相应计划，在没有需要将长曝光拆分的情况下，参照原$b$、$y$、$Hw$方式书写。注意滤光片名称必须和观测系统中的名称（包括大小写）一致，否则生成的列表会无法正常运行。

### expmode.txt

该文件列出实际观测模式（滤光片+曝光时间）与计划之间的匹配情况，在实验阶段，有可能对某种计划进行了不同时间长度的曝光，或者后来调整了曝光时间，但是原有数据仍然认可，这些都需要去额外匹配。未在本文件中列出的模式，数据将不会被列入已观测情况，但是不影响数据处理程序。

本文件每一行包括一种观测模式，以及该模式对应的计划，以及完成系数。正常情况下系数均为1.0。

### files.Jjjjj.lst

本文件列出当晚的观测fits文件，每行一个。该操作通过ls命令手动完成（或者通过Windows的dir命令），然后_**必须**手动检查_，*从列表中删除观测失败、出错、无效的文件名*。程序本身不会去检查文件质量，该步骤必须手工完成。

### report.jjjj.yyyy.mm.dd.txt

观测脚本生成过程的包括，包括了以下几个部分：

1. 当天晚上的日出、日落以及开始、结束观测时间，这个时间是估算的，与实际情况可能有误差，如果觉得观测开始时间与实际执行情况出入较大，请在脚本生成时手工指定。
2. 当天晚上的MJD、午夜（根据经度算，而不是时区）的恒星时、月亮坐标、月相等，月亮坐标主要用于避开月球附近的天区，默认为50°范围，以午夜的月球坐标进行计算，实际上从月出到月落，月球在天球上将走动6°左右，也就是在午夜基础上±3°左右，本程序忽略不计。
3. 当天晚上开始前的天区数，包括总视场、今晚可观测视场、已观测视场、日月附近剔除视场等，以及划分区块情况。
4. 当晚的观测区块选择情况，每行列出一个区块，选择的时间、区块编号、中心坐标、当时恒星时、时角、大气质量等等。该列表用于非连续观测（如中断，或者未按时开始）的情况下选择合适的开始点。
5. 注意，在观测后期，将遇到没有合适的观测天区的情况，此时程序会跳过一段时间，请手工检查，并且合理安排。跳过的时间会有警报。
6. 最后是观测汇总情况，包括今晚计划曝光次数、总观测时间，以及预测的大气质量分布等等。

以上报告也会实时显示在屏幕上，生成脚本时请注意检查。

### sumblock.jjjj.yyyy.mm.dd.txt & sumfield.jjjj.yyyy.mm.dd.txt

观测脚本生成时的每个区块、视场的汇总，包括预估的观测时间、大气质量等等信息。在观测过程中，如果有中断，那么恢复中断时必须检查这两个文件，选择合适的恢复位置。在正常观测中，也要定期核对，确保预估的观测时间和实际保持协调。如果发现实际观测速度和预估的有较大出入，应及时分析原因，调整程序参数。


